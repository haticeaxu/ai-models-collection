# -*- coding: utf-8 -*-
"""Final_Sayisal_Goruntu.ipynb adlÄ± not defterinin kopyasÄ±

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1861tbjhYiutwY5XOTpfC_HnjtqSm9sp3
"""

from google.colab import drive
drive.mount('/content/drive')

"""# 1.	KÃ¼tÃ¼phanelerin Ä°Ã§e AktarÄ±lmasÄ±



Veri iÅŸleme iÃ§in pandas, sayÄ±sal iÅŸlemler iÃ§in numpy, opencv ve skimage gÃ¶rselleÅŸtirme iÃ§in matplotlib ve seaborn kÃ¼tÃ¼phanelerini iÃ§e aktarÄ±yoruz.







"""

import os
import pandas as pd
from skimage import io, exposure, morphology, measure
from skimage.filters import try_all_threshold, threshold_otsu, threshold_li
from scipy.ndimage import gaussian_filter, median_filter
import matplotlib.pyplot as plt
import numpy as np
import cv2

"""# 2. GÃ¶rÃ¼ntÃ¼ YÃ¼kleme ve GÃ¶rselleÅŸtirme Ä°ÅŸlemlerine BaÅŸlÄ±yoruz
### GÃ¶rÃ¼nÃ¼lerin bulunduÄŸu dosya yolu ve listesini alÄ±yoruz



"""

image_folder = '/content/drive/MyDrive/goruntu_akciger'

image_files = os.listdir(image_folder)

"""### GÃ¶rÃ¼ntÃ¼ dosyalarÄ±nÄ± bir DataFrame'e ekleliyoruz"""

train_df = pd.DataFrame({'Image': image_files})

"""### Rastgele GÃ¶rÃ¼ntÃ¼ler SeÃ§iyoruz


"""

random_images = train_df.sample(n=9, random_state=42)

selected_images = [
    io.imread(os.path.join(image_folder, img), as_gray=True)
    for img in random_images['Image']
]

"""### GÃ¶rÃ¼ntÃ¼leri 3x3 matris halinde gÃ¶rselleÅŸtirerek veri setindeki Ã¶rnek gÃ¶rÃ¼ntÃ¼leri inceliyoruz"""

plt.figure(figsize=(12, 12))
for i, img in enumerate(selected_images):
    plt.subplot(3, 3, i + 1)  # 3x3 matris halinde gÃ¶rselleÅŸtirme
    plt.imshow(img, cmap='gray')
    plt.title(random_images['Image'].iloc[i])  # GÃ¶rÃ¼ntÃ¼ isimlerini baÅŸlÄ±k olarak ekler
    plt.axis('off')
plt.tight_layout()
plt.show()

"""#3. GÃ¶rÃ¼ntÃ¼ Ä°ÅŸleme ve Ä°yileÅŸtirme (Pre-processing)

###3.1. Crop, gÃ¶rÃ¼ntÃ¼yÃ¼ kenarlardan kÄ±rpmak iÃ§in kullanÄ±lan basit bir fonksiyon. VarsayÄ±lan olarak her kenardan 50 piksel kÄ±rpar. Manuel ya da dinamik olarak seÃ§im yapÄ±labilir.

  Parametreler:
  
    - top: Ãœstten kÄ±rpÄ±lacak piksel sayÄ±sÄ±
    - bottom: Alttan kÄ±rpÄ±lacak piksel sayÄ±sÄ±
    - left: Soldan kÄ±rpÄ±lacak piksel sayÄ±sÄ±
    - right: SaÄŸdan kÄ±rpÄ±lacak piksel sayÄ±sÄ±
"""

# GÃ¶rÃ¼ntÃ¼yÃ¼ sabit parametrelerle kÄ±rpma fonksiyonu
  def crop_image(image, top=60, bottom=160, left=100, right=100):
      """GÃ¶rÃ¼ntÃ¼yÃ¼ her bir kenardan sabit piksel deÄŸerleriyle kÄ±rpar."""
      if image.shape[0] <= (top + bottom) or image.shape[1] <= (left + right):
            raise ValueError("KÄ±rpma parametreleri gÃ¶rÃ¼ntÃ¼ boyutlarÄ±ndan bÃ¼yÃ¼k olamaz.")
      return image[top:image.shape[0]-bottom, left:image.shape[1]-right]

# Orijinal ve kÄ±rpÄ±lmÄ±ÅŸ gÃ¶rÃ¼ntÃ¼leri gÃ¶rselleÅŸtir
    cropped_images = [crop_image(img, top=80, bottom=150, left=80, right=80) for img in selected_images]

    plt.figure(figsize=(18, 12))

    for i, (original, cropped) in enumerate(zip(selected_images, cropped_images)):
        # Orijinal gÃ¶rÃ¼ntÃ¼
        plt.subplot(2, 9, i + 1)
        plt.imshow(original, cmap='gray')
        plt.title("Orijinal")
        plt.axis("off")

        # KÄ±rpÄ±lmÄ±ÅŸ gÃ¶rÃ¼ntÃ¼
        plt.subplot(2, 9, i + 10)
        plt.imshow(cropped, cmap='gray')
        plt.title("KÄ±rpÄ±lmÄ±ÅŸ")
        plt.axis("off")

    plt.tight_layout()
    plt.show()

"""###3.2. Kontrast Germe (Stretching) ve Histogram EÅŸitleme (Equalization)"""

# 2. AÅŸama: Kontrast Germe (Stretching) ve Histogram EÅŸitleme (Equalization)
    def contrast_stretching(image):
        """GÃ¶rÃ¼ntÃ¼ye kontrast germe iÅŸlemi uygular."""
        p2, p98 = np.percentile(image, (2, 98))  # %2 ve %98 yÃ¼zdelik deÄŸerlerini al
        stretched_image = exposure.rescale_intensity(image, in_range=(p2, p98))
        return stretched_image

    def histogram_equalization(image):
        """GÃ¶rÃ¼ntÃ¼ye histogram eÅŸitleme iÅŸlemi uygular."""
        equalized_image = exposure.equalize_hist(image)
        return equalized_image

    # Kontrast germe ve histogram eÅŸitleme iÅŸlemlerini uygula
    stretched_images = [contrast_stretching(img) for img in cropped_images]
    equalized_images = [histogram_equalization(img) for img in cropped_images]

    # DÃ¶nÃ¼ÅŸÃ¼me uÄŸramÄ±ÅŸ gÃ¶rÃ¼ntÃ¼leri gÃ¶rselleÅŸtir
    plt.figure(figsize=(18, 18))

    for i, (cropped, stretched, equalized) in enumerate(zip(cropped_images, stretched_images, equalized_images)):
        # KÄ±rpÄ±lmÄ±ÅŸ gÃ¶rÃ¼ntÃ¼
        plt.subplot(3, 9, i + 1)
        plt.imshow(cropped, cmap='gray')
        plt.title("KÄ±rpÄ±lmÄ±ÅŸ")
        plt.axis("off")

        # Kontrast gerilmiÅŸ gÃ¶rÃ¼ntÃ¼
        plt.subplot(3, 9, i + 10)
        plt.imshow(stretched, cmap='gray')
        plt.title("Stretching")
        plt.axis("off")

        # Histogram eÅŸitlenmiÅŸ gÃ¶rÃ¼ntÃ¼
        plt.subplot(3, 9, i + 19)
        plt.imshow(equalized, cmap='gray')
        plt.title("Equalization")
        plt.axis("off")

    plt.tight_layout()
    plt.show()

"""### 3.3. GÃ¼rÃ¼ltÃ¼ Azaltma Ä°ÅŸlemleri (Median ve Gaussian Blur)"""

# 3. AÅŸama: GÃ¼rÃ¼ltÃ¼ Azaltma Ä°ÅŸlemleri (Median ve Gaussian Blur)
    def apply_gaussian_blur(image, sigma=1):
        """Gaussian Blur yÃ¶ntemiyle gÃ¼rÃ¼ltÃ¼ azaltÄ±r."""
        return gaussian_filter(image, sigma=sigma)

    def apply_median_filter(image, size=3):
        """Median Filter yÃ¶ntemiyle gÃ¼rÃ¼ltÃ¼ azaltÄ±r."""
        return median_filter(image, size=size)

    # GÃ¼rÃ¼ltÃ¼ azaltma iÅŸlemlerini uygula
    gaussian_blurred_images = [apply_gaussian_blur(img) for img in equalized_images]
    median_filtered_images = [apply_median_filter(img) for img in equalized_images]

    # GÃ¼rÃ¼ltÃ¼ azaltÄ±lmÄ±ÅŸ gÃ¶rÃ¼ntÃ¼leri gÃ¶rselleÅŸtir
    plt.figure(figsize=(18, 18))

    for i, (equalized, gaussian_blurred, median_filtered) in enumerate(zip(equalized_images, gaussian_blurred_images, median_filtered_images)):
        # Histogram eÅŸitlenmiÅŸ gÃ¶rÃ¼ntÃ¼
        plt.subplot(3, 9, i + 1)
        plt.imshow(equalized, cmap='gray')
        plt.title("Equalized")
        plt.axis("off")

        # Gaussian Blur uygulanmÄ±ÅŸ gÃ¶rÃ¼ntÃ¼
        plt.subplot(3, 9, i + 10)
        plt.imshow(gaussian_blurred, cmap='gray')
        plt.title("Gaussian Blur")
        plt.axis("off")

        # Median Filter uygulanmÄ±ÅŸ gÃ¶rÃ¼ntÃ¼
        plt.subplot(3, 9, i + 19)
        plt.imshow(median_filtered, cmap='gray')
        plt.title("Median Filter")
        plt.axis("off")

    plt.tight_layout()
    plt.show()

"""# 3.4. Gauss YoÄŸunluk DÃ¶nÃ¼ÅŸÃ¼mÃ¼ ile EÅŸikleme"""

# 4. AÅŸama: Gauss YoÄŸunluk DÃ¶nÃ¼ÅŸÃ¼mÃ¼ ile EÅŸikleme
    def gaussian_intensity_transform(image, mean=None, std=None):
        """GÃ¶rÃ¼ntÃ¼ye Gauss yoÄŸunluk dÃ¶nÃ¼ÅŸÃ¼mÃ¼ uygular ve eÅŸikleme yapar."""
        if mean is None:
            mean = np.mean(image)
        if std is None:
            std = np.std(image)

        lower_bound = mean - std
        upper_bound = mean + std

        transformed_image = np.clip(image, lower_bound, upper_bound)
        transformed_image = (transformed_image - lower_bound) / (upper_bound - lower_bound)  # Normalize et
        return transformed_image

    # EÅŸikleme iÅŸlemini uygula
    gaussian_transformed_images = [gaussian_intensity_transform(img) for img in gaussian_blurred_images]

    # EÅŸiklenmiÅŸ gÃ¶rÃ¼ntÃ¼leri gÃ¶rselleÅŸtir
    plt.figure(figsize=(18, 12))

    for i, (original, transformed) in enumerate(zip(gaussian_blurred_images, gaussian_transformed_images)):
        # Orijinal Gaussian Blur gÃ¶rÃ¼ntÃ¼
        plt.subplot(2, 9, i + 1)
        plt.imshow(original, cmap='gray')
        plt.title("Gaussian Blur")
        plt.axis("off")

        # Gauss yoÄŸunluk dÃ¶nÃ¼ÅŸÃ¼mÃ¼ uygulanmÄ±ÅŸ gÃ¶rÃ¼ntÃ¼
        plt.subplot(2, 9, i + 10)
        plt.imshow(transformed, cmap='gray')
        plt.title("Gaussian Transform")
        plt.axis("off")

    plt.tight_layout()
    plt.show()

"""GÃ¶rÃ¼ntÃ¼lerin Gauss YoÄŸunluk DaÄŸÄ±lÄ±mÄ±"""

import numpy as np
import matplotlib.pyplot as plt

# Her kÄ±rpÄ±lmÄ±ÅŸ gÃ¶rÃ¼ntÃ¼ iÃ§in ortalama ve standart sapma hesapla
means = [np.mean(img) for img in cropped_images]
stds = [np.std(img) for img in cropped_images]

# KÄ±rpÄ±lmÄ±ÅŸ gÃ¶rÃ¼ntÃ¼ler iÃ§in Gauss yoÄŸunluk daÄŸÄ±lÄ±mÄ±nÄ± gÃ¶rselleÅŸtir
for i, (image, mean, std) in enumerate(zip(cropped_images, means, stds)):
    plt.figure(figsize=(6, 4))  # Grafik boyutunu ayarla

    # YoÄŸunluk deÄŸerlerini temsil eden x ekseni (0-255 arasÄ±)
    x = np.linspace(0, 255, 256)

    # Gauss yoÄŸunluk fonksiyonunu hesapla
    gauss_curve = (1 / (std * np.sqrt(2 * np.pi))) * np.exp(-0.5 * ((x - mean) / std) ** 2)

    # Gauss eÄŸrisini Ã§iz
    plt.plot(x, gauss_curve, color='red', label='Gauss DaÄŸÄ±lÄ±mÄ±')

    # Ortalama deÄŸeri gÃ¶steren dikey Ã§izgi
    plt.axvline(mean, color='black', linestyle='--', label='Ortalama')

    # -1 ve +1 standart sapmalarÄ± gÃ¶steren dikey Ã§izgiler
    plt.axvline(mean - std, color='blue', linestyle='--', label='-1 Std')
    plt.axvline(mean + std, color='blue', linestyle='--', label='+1 Std')

    # Grafik baÅŸlÄ±k ve etiketlerini ayarla
    plt.title(f"GÃ¶rÃ¼ntÃ¼ {i + 1} - Gauss YoÄŸunluk DaÄŸÄ±lÄ±mÄ±")
    plt.xlabel("YoÄŸunluk DeÄŸeri (0-255)")
    plt.ylabel("OlasÄ±lÄ±k YoÄŸunluÄŸu")

    # Grafik aÃ§Ä±klama ve Ä±zgara ekle
    plt.legend()
    plt.grid()

    # GrafiÄŸi gÃ¶ster
    plt.show()

"""### 3.4.	EÅŸik SayÄ±sÄ± Eelirleme"""

import numpy as np
import matplotlib.pyplot as plt
from skimage.filters import threshold_multiotsu
from scipy.stats import norm

def gaussian_intensity_transform(image):
    """GÃ¶rÃ¼ntÃ¼ye Gauss yoÄŸunluk dÃ¶nÃ¼ÅŸÃ¼mÃ¼ uygular ve dinamik eÅŸikleme yapar."""

    mean = np.mean(image)  # Dinamik Ortalama
    std = np.std(image)    # Dinamik Standart Sapma

    lower_bound = mean - std
    upper_bound = mean + std

    # YoÄŸunluÄŸu normalize et (Bu aralÄ±kta kalan pikseller vurgulanacak)
    transformed_image = np.clip(image, lower_bound, upper_bound)
    transformed_image = (transformed_image - lower_bound) / (upper_bound - lower_bound)

    return transformed_image, mean, std

# ğŸ”¹ Ã–rnek: KÄ±rpÄ±lmÄ±ÅŸ GÃ¶rÃ¼ntÃ¼ler iÃ§in Gauss DÃ¶nÃ¼ÅŸÃ¼mÃ¼ ve Histogram Ã‡izimi
for i, cropped_image in enumerate(cropped_images):
    transformed_image, mean, std = gaussian_intensity_transform(cropped_image)

    # Histogram GrafiÄŸi
    plt.figure(figsize=(8, 5))
    x = np.linspace(0, 255, 256)
    gauss_curve = norm.pdf(x, mean, std)  # Gauss DaÄŸÄ±lÄ±mÄ±
    plt.plot(x, gauss_curve, color='red', label='Gauss DaÄŸÄ±lÄ±mÄ±')

    # Ortalama ve Standart Sapma Ã‡izgileri
    plt.axvline(mean, color='black', linestyle='--', label='Ortalama')
    plt.axvline(mean - std, color='blue', linestyle='--', label='-1 Std')
    plt.axvline(mean + std, color='blue', linestyle='--', label='+1 Std')

    plt.title("Intensity Transformation iÃ§in Gauss DaÄŸÄ±lÄ±mÄ±")
    plt.xlabel("YoÄŸunluk DeÄŸeri (0-255)")
    plt.ylabel("DaÄŸÄ±lÄ±m (OlasÄ±lÄ±k YoÄŸunluÄŸu)")
    plt.legend()
    plt.grid()
    plt.show()

    # ğŸ”¹ Tek eÅŸik mi? Ã‡oklu eÅŸik mi? KullanÄ±cÄ± tercihi
    num_thresholds = 2  # 2 iÃ§in alt-orta-Ã¼st, 5 iÃ§in detaylÄ± bÃ¶lgeleme

    # Multi-Otsu ile BÃ¶lgelere AyÄ±rma
    thresholds = threshold_multiotsu(cropped_image, classes=num_thresholds + 1)
    multi_thresholded_image = np.digitize(cropped_image, bins=thresholds)

    # Orta bÃ¶lgeyi 1, diÄŸer her ÅŸeyi 0 yap
    binary_segmented = np.where((multi_thresholded_image == 1), 1, 0)

    # ğŸ”¹ Segmentasyonu GÃ¶rselleÅŸtir
    plt.figure(figsize=(12, 6))
    plt.subplot(1, 3, 1)
    plt.imshow(cropped_image, cmap='gray')
    plt.title("Orijinal KÄ±rpÄ±lmÄ±ÅŸ GÃ¶rÃ¼ntÃ¼")
    plt.axis("off")

    plt.subplot(1, 3, 2)
    plt.imshow(transformed_image, cmap='gray')
    plt.title("Gauss YoÄŸunluk DÃ¶nÃ¼ÅŸÃ¼mÃ¼")
    plt.axis("off")

    plt.subplot(1, 3, 3)
    plt.imshow(binary_segmented, cmap='gray')
    plt.title("Optimum EÅŸikleme Sonucu")
    plt.axis("off")

    plt.tight_layout()
    plt.show()

"""# 4. Thresholding
### 4.1. Thresholding (Global ve Otsu): EÅŸik deÄŸerlerini gÃ¶rÃ¼ntÃ¼lere uygulayarak binary gÃ¶rÃ¼ntÃ¼leri gÃ¶rselleÅŸtirip uygun thresholding yÃ¶ntemini seÃ§ildi ve yorumlar eklendi.
"""

# 5. AÅŸama: Thresholding (Global ve Otsu)
    binary_images = []
    for i, cropped in enumerate(cropped_images):
        # Global Thresholding
        global_thresh = np.mean(cropped)
        binary_global = cropped > global_thresh

        # Otsu Thresholding
        otsu_thresh = threshold_otsu(cropped)
        binary_otsu = cropped > otsu_thresh

        # Otsu sonucu seÃ§iliyor (Ã¶rnek)
        binary_images.append(binary_otsu)

        # TÃ¼m threshold yÃ¶ntemlerini gÃ¶ster
        fig, ax = try_all_threshold(cropped, figsize=(10, 8), verbose=False)
        plt.suptitle(f"GÃ¶rÃ¼ntÃ¼ {i+1} - TÃ¼m Threshold YÃ¶ntemleri", fontsize=16)
        plt.show()

        # SonuÃ§larÄ± gÃ¶rselleÅŸtir
        plt.figure(figsize=(12, 6))

        # Orijinal gÃ¶rÃ¼ntÃ¼
        plt.subplot(1, 3, 1)
        plt.imshow(cropped, cmap='gray')
        plt.title("KÄ±rpÄ±lmÄ±ÅŸ")
        plt.axis("off")

        # Global Thresholding sonucu
        plt.subplot(1, 3, 2)
        plt.imshow(binary_global, cmap='gray')
        plt.title(f"Global Thresh (T={global_thresh:.2f})")
        plt.axis("off")

        # Otsu Thresholding sonucu
        plt.subplot(1, 3, 3)
        plt.imshow(binary_otsu, cmap='gray')
        plt.title(f"Otsu Thresh (T={otsu_thresh:.2f})")
        plt.axis("off")

        plt.tight_layout()
        plt.show()

        # Yorumlama iÃ§in bilgi ekle
        print(f"GÃ¶rÃ¼ntÃ¼ {i+1}:")
        print(f"  - Global Thresholding ile belirlenen eÅŸik: {global_thresh:.2f}")
        print(f"  - Otsu Thresholding ile belirlenen eÅŸik: {otsu_thresh:.2f}")
        print("  Yorum: Global Thresholding, sabit bir eÅŸik deÄŸerine dayalÄ±dÄ±r ve kontrast dÃ¼ÅŸÃ¼kse yetersiz kalabilir. ")
        print("         Otsu Thresholding ise histogram bilgisine dayalÄ±dÄ±r ve daha adaptiftir, genellikle daha iyi sonuÃ§ verir.")
        print("\n")

"""# 5. Post-Processing (Morfolojik Operasyonlar)

### 5.1.	Uygun morfolojik operatÃ¶rleri, uygun structural element yapÄ±sÄ± ve boyutunu seÃ§erek gÃ¶rÃ¼ntÃ¼ye uygulayÄ±nÄ±z. GiriÅŸ ve Ã‡Ä±kÄ±ÅŸ GÃ¶rÃ¼ntÃ¼lerini gÃ¶rseleÅŸtirin
"""

from skimage import morphology
import matplotlib.pyplot as plt

# Structural Element SeÃ§imi
struct_elem = morphology.disk(3)  # Disk ÅŸeklinde kernel

for i, binary_image in enumerate(binary_images):
    # 1ï¸âƒ£ AÃ§ma Ä°ÅŸlemi (Opening) â†’ KÃ¼Ã§Ã¼k gÃ¼rÃ¼ltÃ¼leri temizler
    opened_image = morphology.binary_opening(binary_image, struct_elem)

    # 2ï¸âƒ£ Kapama Ä°ÅŸlemi (Closing) â†’ KÃ¼Ã§Ã¼k boÅŸluklarÄ± kapatÄ±r
    closed_image = morphology.binary_closing(opened_image, struct_elem)

    # 3ï¸âƒ£ Erozyon ve Dilasyon Testi
    eroded_image = morphology.binary_erosion(binary_image, struct_elem)
    dilated_image = morphology.binary_dilation(binary_image, struct_elem)

    # ğŸ”¹ GÃ¶rselleÅŸtirme
    plt.figure(figsize=(18, 12))

    plt.subplot(2, 3, 1)
    plt.imshow(binary_image, cmap='gray')
    plt.title("Orijinal Binary GÃ¶rÃ¼ntÃ¼")
    plt.axis("off")

    plt.subplot(2, 3, 2)
    plt.imshow(opened_image, cmap='gray')
    plt.title("AÃ§ma Ä°ÅŸlemi (Opening)")
    plt.axis("off")

    plt.subplot(2, 3, 3)
    plt.imshow(closed_image, cmap='gray')
    plt.title("Kapama Ä°ÅŸlemi (Closing)")
    plt.axis("off")

    plt.subplot(2, 3, 4)
    plt.imshow(eroded_image, cmap='gray')
    plt.title("Erozyon (Erosion)")
    plt.axis("off")

    plt.subplot(2, 3, 5)
    plt.imshow(dilated_image, cmap='gray')
    plt.title("Dilasyon (Dilation)")
    plt.axis("off")

    plt.tight_layout()
    plt.show()

    # Bilgilendirme
    print(f"GÃ¶rÃ¼ntÃ¼ {i+1} iÃ§in Morfolojik Ä°ÅŸlemler TamamlandÄ±.")
    print("  - AÃ§ma (Opening): KÃ¼Ã§Ã¼k gÃ¼rÃ¼ltÃ¼ler temizlendi.")
    print("  - Kapama (Closing): Nesne Ã¼zerindeki boÅŸluklar dolduruldu.")
    print("  - Erozyon: Nesne sÄ±nÄ±rlarÄ± daraltÄ±ldÄ±.")
    print("  - Dilasyon: Nesne sÄ±nÄ±rlarÄ± geniÅŸletildi.")
    print("\n")

"""### 5.2.	GÃ¶rÃ¼ntÃ¼ye baÄŸlantÄ± bileÅŸen analizi (connected component labeling-CCL) (cv2.connectedComponents) uygulayarak olasÄ± bÃ¶lge sayÄ±sÄ±nÄ± print CCL Ã§Ä±ktÄ±sÄ±nÄ± plot edin."""

import cv2
import numpy as np
import matplotlib.pyplot as plt

for i, binary_image in enumerate(binary_images):
    # ğŸ”¹ OpenCV'nin connectedComponents fonksiyonunu kullanarak CCL uygulama
    num_labels, labels_im = cv2.connectedComponents(binary_image.astype(np.uint8))

    # ğŸ”¹ CCL Ã‡Ä±ktÄ±sÄ±nÄ± GÃ¶rselleÅŸtirme (Her bÃ¶lge farklÄ± renk alÄ±r)
    plt.figure(figsize=(8, 6))
    plt.imshow(labels_im, cmap='nipy_spectral')
    plt.title(f"GÃ¶rÃ¼ntÃ¼ {i+1} - BaÄŸlantÄ±lÄ± BileÅŸenler (CCL)")
    plt.axis("off")
    plt.colorbar()
    plt.show()

    # ğŸ”¹ BÃ¶lge SayÄ±sÄ±nÄ± Ekrana YazdÄ±r
    print(f"GÃ¶rÃ¼ntÃ¼ {i+1} iÃ§in baÄŸlantÄ±lÄ± bileÅŸen sayÄ±sÄ±: {num_labels}")

    # ğŸ”¹ DetaylÄ± BÃ¶lge Bilgileri (Connected Components with Stats)
    num_labels, labels_im, stats, centroids = cv2.connectedComponentsWithStats(binary_image.astype(np.uint8))

    print(f"\nGÃ¶rÃ¼ntÃ¼ {i+1} iÃ§in baÄŸlantÄ±lÄ± bileÅŸen analizi sonuÃ§larÄ±:")
    for label in range(1, num_labels):  # 0 etiketi arka plan olduÄŸu iÃ§in atlanÄ±r
        print(f"  - BÃ¶lge {label}:")
        print(f"    - Alan: {stats[label, cv2.CC_STAT_AREA]}")
        print(f"    - Bounding Box: (x={stats[label, cv2.CC_STAT_LEFT]}, y={stats[label, cv2.CC_STAT_TOP]},"
              f" w={stats[label, cv2.CC_STAT_WIDTH]}, h={stats[label, cv2.CC_STAT_HEIGHT]})")
        print(f"    - Merkez KoordinatlarÄ±: {centroids[label]}")
    print("\n" + "=" * 50 + "\n")

"""### 5.3.	Elde ettiÄŸiniz labellar iÃ§in, Centroid ve Area bilgilerinin kesinlikle olacaÄŸÄ±, ayrÄ±ca bÃ¶lgelerin yoÄŸunluk ve ÅŸekilsel Ã¶zelliklerini belirten en az 5 tane Ã¶zniteliÄŸi print edin.
o	(cv2.connectedComponentsWithStats Ã¶nerebilirim ama scikit-imageâ€™Ä±n regionprops u daha iyi)

"""

from skimage.measure import regionprops, label
from skimage import morphology, filters
import numpy as np
import matplotlib.pyplot as plt

for i, binary_image in enumerate(binary_images):
    # ğŸ”¹ Otsu Thresholding
    threshold = filters.threshold_otsu(binary_image)
    mask = binary_image > threshold

    # ğŸ”¹ Morfolojik Ä°ÅŸlemler
    mask = morphology.remove_small_objects(mask, 50)
    mask = morphology.remove_small_holes(mask, 50)

    # ğŸ”¹ BaÄŸlantÄ±lÄ± BileÅŸenler Etiketleme
    labels = label(mask)

    # ğŸ”¹ Regionprops ile Ã–znitelik Ã‡Ä±karma
    regions = regionprops(labels, intensity_image=binary_image)

    print(f"\nGÃ¶rÃ¼ntÃ¼ {i+1} iÃ§in baÄŸlantÄ±lÄ± bileÅŸen analizi:")
    print("=" * 60)

    for region in regions:
        centroid = region.centroid
        area = region.area
        perimeter = region.perimeter
        eccentricity = region.eccentricity
        mean_intensity = region.mean_intensity

        print(f"  - BÃ¶lge ID: {region.label}")
        print(f"    - Merkez (Centroid): {centroid}")
        print(f"    - Alan (Area): {area}")
        print(f"    - Ã‡evre (Perimeter): {perimeter}")
        print(f"    - Eksantriklik (Eccentricity): {eccentricity:.2f}")
        print(f"    - Ortalama YoÄŸunluk (Mean Intensity): {mean_intensity:.2f}")
        print("-" * 60)

    # ğŸ”¹ CCL Ã‡Ä±ktÄ±sÄ±nÄ± GÃ¶rselleÅŸtirme
    plt.figure(figsize=(8, 6))
    plt.imshow(labels, cmap='nipy_spectral')
    plt.title(f"GÃ¶rÃ¼ntÃ¼ {i+1} - BaÄŸlantÄ±lÄ± BileÅŸenler (CCL)")
    plt.axis("off")
    plt.colorbar()
    plt.show()

"""### 5.4.	Elde ettiÄŸiniz stats ve labelslarÄ± inceleyerek akciÄŸer alanlarÄ±nÄ± en iyi ifade eden Ã¶znitelikleri yorumlayÄ±nÄ±z.
o	BelirlediÄŸniz Ã¶zniteliklere gÃ¶re filtreleme yapÄ±n. (Ã¶rn: maks alana sahip ilk iki bÃ¶lge, if maks alana sahip iki bÃ¶lge and bÃ¶lgelerin centroidleri ortada; filter; else try 3. BÃ¶lge; return)
o	Belirleyici Ã¶znitelik bulunamadÄ±ysa. Her gÃ¶rÃ¼ntÃ¼de otomatik olarak label belirleyen algoritmayÄ± yazÄ±n

"""

from skimage.measure import regionprops, label
from skimage import morphology, filters
import numpy as np
import cv2
import matplotlib.pyplot as plt

def detect_lungs(binary_image):
    """ AkciÄŸer alanlarÄ±nÄ± en iyi ifade eden iki bÃ¶lgeyi belirle """

    # ğŸ”¹ BaÄŸlantÄ±lÄ± BileÅŸenleri Etiketleme
    labels = label(binary_image)
    regions = regionprops(labels, intensity_image=binary_image)

    # ğŸ”¹ Ã–zniteliklerin AlÄ±nmasÄ±
    lung_regions = sorted(regions, key=lambda x: x.area, reverse=True)[:3]  # En bÃ¼yÃ¼k 3 bÃ¶lgeyi al

    # ğŸ”¹ GÃ¶rÃ¼ntÃ¼ Merkezi
    image_center = (binary_image.shape[1] // 2, binary_image.shape[0] // 2)

    selected_regions = []

    for region in lung_regions:
        centroid_x, centroid_y = region.centroid
        area = region.area
        eccentricity = region.eccentricity

        # ğŸ”¹ Åartlar: Alan bÃ¼yÃ¼k olacak ve centroid merkeze yakÄ±n olacak
        if (abs(centroid_x - image_center[0]) < image_center[0] * 0.3) and (eccentricity > 0.6):
            selected_regions.append(region)

        if len(selected_regions) == 2:
            break  # En iyi 2 bÃ¶lgeyi seÃ§tik

    # ğŸ”¹ EÄŸer 2 bÃ¶lge bulunamadÄ±ysa, 3. bÃ¶lgeyi dene
    if len(selected_regions) < 2 and len(lung_regions) > 2:
        selected_regions.append(lung_regions[2])

    # ğŸ”¹ SonuÃ§larÄ± GÃ¶rselleÅŸtir
    mask = np.zeros_like(binary_image)
    for region in selected_regions:
        mask[labels == region.label] = 1

    return mask, selected_regions

# ğŸ”¹ TÃ¼m GÃ¶rÃ¼ntÃ¼ler Ä°Ã§in Uygula
for i, binary_image in enumerate(binary_images):
    lung_mask, selected_regions = detect_lungs(binary_image)

    # ğŸ”¹ SonuÃ§larÄ± GÃ¶rselleÅŸtir
    plt.figure(figsize=(12, 6))

    plt.subplot(1, 2, 1)
    plt.imshow(binary_image, cmap='gray')
    plt.title(f"GÃ¶rÃ¼ntÃ¼ {i+1} - Orijinal Binary")
    plt.axis("off")

    plt.subplot(1, 2, 2)
    plt.imshow(lung_mask, cmap='gray')
    plt.title(f"GÃ¶rÃ¼ntÃ¼ {i+1} - SeÃ§ilen AkciÄŸer BÃ¶lgeleri")
    plt.axis("off")

    plt.tight_layout()
    plt.show()

    # ğŸ”¹ SeÃ§ilen BÃ¶lgelere Ait Ã–znitelikler
    print(f"\nGÃ¶rÃ¼ntÃ¼ {i+1} iÃ§in seÃ§ilen akciÄŸer bÃ¶lgeleri:")
    print("=" * 60)
    for region in selected_regions:
        print(f"  - BÃ¶lge ID: {region.label}")
        print(f"    - Merkez (Centroid): {region.centroid}")
        print(f"    - Alan (Area): {region.area}")
        print(f"    - Eksantriklik (Eccentricity): {region.eccentricity:.2f}")
        print("-" * 60)

"""### 5.5.	SeÃ§tiÄŸiniz labela sahip filtrelenmiÅŸ gÃ¶rÃ¼ntÃ¼lere uygun morfolojik iÅŸlemleri (structural elemant tipi ve boyutu belirleyerek) uygulayÄ±n. GiriÅŸ ve Ã§Ä±kÄ±ÅŸ gÃ¶rÃ¼ntÃ¼lerini gÃ¶rselleÅŸtirin."""

from skimage.morphology import binary_erosion, binary_dilation, binary_closing, disk
import numpy as np
import matplotlib.pyplot as plt

def apply_morphology_fixed(lung_mask):
    """ AkciÄŸer maskesine uygun morfolojik iÅŸlemler uygula. """

    # ğŸ”¹ Maskenin tamamen siyah olup olmadÄ±ÄŸÄ±nÄ± kontrol et
    unique_vals = np.unique(lung_mask)
    if len(unique_vals) == 1 and unique_vals[0] == 0:
        print("UYARI: AkciÄŸer maskesi tamamen siyah! Ä°ÅŸlemi atlÄ±yoruz.")
        return lung_mask, lung_mask, lung_mask

    # ğŸ”¹ Daha kÃ¼Ã§Ã¼k structuring element (Disk, Boyut = 2)
    struct_elem = disk(2)

    # ğŸ”¹ Morfolojik Ä°ÅŸlemler
    eroded = binary_erosion(lung_mask, struct_elem)  # GÃ¼rÃ¼ltÃ¼ temizle (Ã§ok kÃ¼Ã§Ã¼ltmesin)
    dilated = binary_dilation(eroded, disk(10))  # YapÄ±yÄ± biraz daha geniÅŸlet
    closed = binary_closing(dilated, struct_elem)  # KÃ¼Ã§Ã¼k boÅŸluklarÄ± kapat

    return eroded, dilated, closed

# ğŸ”¹ TÃ¼m GÃ¶rÃ¼ntÃ¼ler Ä°Ã§in Uygula
for i, binary_image in enumerate(binary_images):
    lung_mask, selected_regions = detect_lungs(binary_image)

    # Morfolojik iÅŸlemleri uygula
    eroded, dilated, closed = apply_morphology_fixed(lung_mask)

    # ğŸ”¹ SonuÃ§larÄ± GÃ¶rselleÅŸtir
    plt.figure(figsize=(18, 6))

    plt.subplot(1, 4, 1)
    plt.imshow(binary_image, cmap='gray')
    plt.title(f"GÃ¶rÃ¼ntÃ¼ {i+1} - Orijinal Binary")
    plt.axis("off")

    plt.subplot(1, 4, 2)
    plt.imshow(eroded, cmap='gray')
    plt.title(f"GÃ¶rÃ¼ntÃ¼ {i+1} - Erozyon UygulandÄ±")
    plt.axis("off")

    plt.subplot(1, 4, 3)
    plt.imshow(dilated, cmap='gray')
    plt.title(f"GÃ¶rÃ¼ntÃ¼ {i+1} - Dilatasyon UygulandÄ±")
    plt.axis("off")

    plt.subplot(1, 4, 4)
    plt.imshow(closed, cmap='gray')
    plt.title(f"GÃ¶rÃ¼ntÃ¼ {i+1} - Closing UygulandÄ±")
    plt.axis("off")

    plt.tight_layout()
    plt.show()

# Post-Processing (Morfolojik Operasyonlar)
    if not binary_images:
        print("Hata: Binary gÃ¶rÃ¼ntÃ¼ler mevcut deÄŸil. Thresholding aÅŸamasÄ±nÄ± kontrol edin.")
    else:
        for i, binary_image in enumerate(binary_images):
            # Structuring Element ve Morfolojik Operasyonlar
            struct_elem = morphology.disk(3)  # Disk ÅŸeklinde bir structuring element
            morphed_image = morphology.binary_closing(binary_image, struct_elem)  # Closing iÅŸlemi

            # GiriÅŸ ve Ã‡Ä±kÄ±ÅŸ GÃ¶rÃ¼ntÃ¼lerini GÃ¶rselleÅŸtir
            plt.figure(figsize=(12, 6))

            # GiriÅŸ Binary GÃ¶rÃ¼ntÃ¼
            plt.subplot(1, 2, 1)
            plt.imshow(binary_image, cmap='gray')
            plt.title("GiriÅŸ Binary GÃ¶rÃ¼ntÃ¼")
            plt.axis("off")

            # Ã‡Ä±kÄ±ÅŸ Morfolojik Ä°ÅŸlem GÃ¶rÃ¼ntÃ¼sÃ¼
            plt.subplot(1, 2, 2)
            plt.imshow(morphed_image, cmap='gray')
            plt.title("Morfolojik Ä°ÅŸlem Ã‡Ä±kÄ±ÅŸÄ±")
            plt.axis("off")

            plt.tight_layout()
            plt.show()

            # Yorumlama
            print(f"GÃ¶rÃ¼ntÃ¼ {i+1} iÃ§in Morfolojik Ä°ÅŸlem:")
            print("  - Disk ÅŸeklinde structuring element kullanÄ±ldÄ± (yarÄ±Ã§ap = 3).")
            print("  - Closing iÅŸlemi uygulandÄ±: KÃ¼Ã§Ã¼k boÅŸluklar kapatÄ±ldÄ± ve nesne kenarlarÄ± dÃ¼zeltildi.")
            print("\n")

"""# SonuÃ§lar"""

import numpy as np
import cv2
import matplotlib.pyplot as plt
from skimage.measure import regionprops, label
from skimage.morphology import binary_erosion, binary_dilation, binary_closing, disk

def detect_lungs_fixed(binary_image):
    """BaÄŸlantÄ±lÄ± bileÅŸen analizi ile en bÃ¼yÃ¼k akciÄŸer bÃ¶lgelerini seÃ§"""

    # BaÄŸlantÄ±lÄ± bileÅŸenleri bul
    labeled_mask, num_labels = label(binary_image, return_num=True)

    # Regionprops ile bileÅŸenlerin alanlarÄ±nÄ± ve centroidlerini al
    regions = regionprops(labeled_mask)

    # EÄŸer hiÃ§ bÃ¶lge yoksa, maskeyi direkt dÃ¶n
    if not regions:
        return np.zeros_like(binary_image), []

    # Alanlara gÃ¶re sÄ±ralama (BÃ¼yÃ¼kten kÃ¼Ã§Ã¼ÄŸe)
    sorted_regions = sorted(regions, key=lambda r: r.area, reverse=True)

    # Ä°lk iki bÃ¼yÃ¼k bÃ¶lgeyi al
    lung_mask = np.zeros_like(binary_image)
    for region in sorted_regions[:2]:  # En bÃ¼yÃ¼k 2 bÃ¶lgeyi seÃ§iyoruz
        lung_mask[labeled_mask == region.label] = 1

    return lung_mask, sorted_regions[:2]

# ğŸ”¹ GÃ¶rÃ¼ntÃ¼ler Ãœzerinde Uygula
for i, (binary_image, original_image) in enumerate(zip(binary_images, selected_images)):
    lung_mask, selected_regions = detect_lungs_fixed(binary_image)

    # ğŸ”¹ Morfolojik Ä°ÅŸlemler
    _, _, closed_mask = apply_morphology_fixed(lung_mask)

    # ğŸ”¹ Maskeyi Orijinal GÃ¶rÃ¼ntÃ¼ ile Ã‡arp (BoyutlarÄ± EÅŸitle)
    resized_mask = cv2.resize(closed_mask.astype(np.uint8), (original_image.shape[1], original_image.shape[0]))
    processed_result = original_image * resized_mask  # Maskeyi uygula

    # ğŸ”¹ SonuÃ§larÄ± GÃ¶rselleÅŸtir
    plt.figure(figsize=(18, 6))

    plt.subplot(1, 3, 1)
    plt.imshow(original_image, cmap='gray')
    plt.title(f"GÃ¶rÃ¼ntÃ¼ {i+1} - Orijinal")
    plt.axis("off")

    plt.subplot(1, 3, 2)
    plt.imshow(resized_mask, cmap='gray')
    plt.title(f"GÃ¶rÃ¼ntÃ¼ {i+1} - Binary Maske")
    plt.axis("off")

    plt.subplot(1, 3, 3)
    plt.imshow(processed_result, cmap='gray')
    plt.title(f"GÃ¶rÃ¼ntÃ¼ {i+1} - Maske ile Ã‡arpÄ±lmÄ±ÅŸ GÃ¶rÃ¼ntÃ¼")
    plt.axis("off")

    plt.tight_layout()
    plt.show()

    # ğŸ”¹ Yorumlama
    print(f"GÃ¶rÃ¼ntÃ¼ {i+1} Ä°Ã§in SonuÃ§lar:")
    print("=" * 60)
    print(f"  - BaÄŸlantÄ±lÄ± bileÅŸen analiziyle **en bÃ¼yÃ¼k 2 bÃ¶lge** seÃ§ildi.")
    print(f"  - EÄŸer hala yanlÄ±ÅŸ Ã§Ä±ktÄ± oluyorsa, **3. en bÃ¼yÃ¼k bÃ¶lge de denenebilir.**")
    print("\n")

"""# SonuÃ§lar V2"""

# Son AÅŸama: Post-Processing (Morfolojik Operasyonlar ve CCL)
    if not binary_images:
        print("Hata: Binary gÃ¶rÃ¼ntÃ¼ler mevcut deÄŸil. Thresholding aÅŸamasÄ±nÄ± kontrol edin.")
    else:
        for i, (binary_image, original_image) in enumerate(zip(binary_images, selected_images)):
            # Structuring Element ve Morfolojik Operasyonlar
            struct_elem = morphology.disk(3)  # Disk ÅŸeklinde bir structuring element
            morphed_image = morphology.binary_closing(binary_image, struct_elem)  # Closing iÅŸlemi

            # GiriÅŸ ve Ã‡Ä±kÄ±ÅŸ GÃ¶rÃ¼ntÃ¼lerini GÃ¶rselleÅŸtir
            plt.figure(figsize=(12, 6))

            # GiriÅŸ Binary GÃ¶rÃ¼ntÃ¼
            plt.subplot(1, 2, 1)
            plt.imshow(binary_image, cmap='gray')
            plt.title("GiriÅŸ Binary GÃ¶rÃ¼ntÃ¼")
            plt.axis("off")

            # Ã‡Ä±kÄ±ÅŸ Morfolojik Ä°ÅŸlem GÃ¶rÃ¼ntÃ¼sÃ¼
            plt.subplot(1, 2, 2)
            plt.imshow(morphed_image, cmap='gray')
            plt.title("Morfolojik Ä°ÅŸlem Ã‡Ä±kÄ±ÅŸÄ±")
            plt.axis("off")

            plt.tight_layout()
            plt.show()

            # CCL Uygulama
            num_labels, labels_im = cv2.connectedComponents(morphed_image.astype(np.uint8))

            # CCL Ã‡Ä±ktÄ±sÄ±nÄ± GÃ¶rselleÅŸtir
            plt.figure(figsize=(8, 6))
            plt.imshow(labels_im, cmap='nipy_spectral')
            plt.title(f"GÃ¶rÃ¼ntÃ¼ {i+1} - BaÄŸlantÄ±lÄ± BileÅŸenler (CCL)")
            plt.axis("off")
            plt.colorbar()
            plt.show()

            # BÃ¶lge SayÄ±sÄ±nÄ± YazdÄ±r
            print(f"GÃ¶rÃ¼ntÃ¼ {i+1} iÃ§in baÄŸlantÄ±lÄ± bileÅŸen sayÄ±sÄ±: {num_labels}")

            # Maske ile Orijinal GÃ¶rÃ¼ntÃ¼yÃ¼ Ã‡arp (BoyutlarÄ± eÅŸitlemek iÃ§in morphed_image'Ä± yeniden boyutlandÄ±r)
            resized_mask = cv2.resize(morphed_image.astype(np.uint8), (original_image.shape[1], original_image.shape[0]))
            processed_result = original_image * resized_mask

            # Orijinal GÃ¶rÃ¼ntÃ¼ ve SonuÃ§ GÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ GÃ¶rselleÅŸtir
            plt.figure(figsize=(12, 6))

            plt.subplot(1, 2, 1)
            plt.imshow(original_image, cmap='gray')
            plt.title("Orijinal GÃ¶rÃ¼ntÃ¼")
            plt.axis("off")

            plt.subplot(1, 2, 2)
            plt.imshow(processed_result, cmap='gray')
            plt.title("Maske ile Ã‡arpÄ±lmÄ±ÅŸ GÃ¶rÃ¼ntÃ¼")
            plt.axis("off")

            plt.tight_layout()
            plt.show()

            # Yorumlama
            print(f"GÃ¶rÃ¼ntÃ¼ {i+1} iÃ§in Ä°ÅŸlem SonuÃ§larÄ±:")
            print("  - Orijinal gÃ¶rÃ¼ntÃ¼ ile maske Ã§arpÄ±larak sadece ilgili bÃ¶lgeler Ã¶n plana Ã§Ä±karÄ±lmÄ±ÅŸtÄ±r.")
            print("  - Maske sayesinde gereksiz bÃ¶lgeler kaldÄ±rÄ±lmÄ±ÅŸtÄ±r.")
            print("\n")